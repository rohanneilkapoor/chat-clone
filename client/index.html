<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
</head>
<style>
  @font-face {
    font-family: 'Satoshi-Regular';
    src: url('../fonts/Satoshi-Regular.woff2') format('woff2'),
        url('../fonts/Satoshi-Regular.woff') format('woff'),
        url('../fonts/Satoshi-Regular.ttf') format('truetype');
        font-weight: 400;
        font-display: swap;
        font-style: normal;
  }
  @font-face {
    font-family: 'Satoshi-Medium';
    src: url('../fonts/Satoshi-Medium.woff2') format('woff2'),
        url('../fonts/Satoshi-Medium.woff') format('woff'),
        url('../fonts/Satoshi-Medium.ttf') format('truetype');
        font-weight: 400;
        font-display: swap;
        font-style: normal;
  }
  body {
      font-family: 'Satoshi-Regular', sans-serif;
      margin: 0 auto;
      color: #232323;
      font-size: 17px;
      line-height: 26px;
      background-color: #FAFAFA;
      -webkit-user-select: text; /* for Chrome and Safari */
      -moz-user-select: text; /* for Firefox */
      -ms-user-select: text; /* for Internet Explorer and Edge */
      user-select: text; /* standard syntax */
  }

  @keyframes flash {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.2;
    }
  }

  .flash {
    animation: flash 2s linear infinite;
  }

  td {
    vertical-align: top;
  }

  #client-form {
    position: fixed;
    bottom: 0;
    padding-right: 16px;
    padding-left: 16px;
    padding-bottom: 32px;
    padding-bottom: 32px;
    width: 100%;
    max-width: 600px; /* adjust as needed */
    box-sizing: border-box;
  }
  input {
    font-family: 'Satoshi-Regular', sans-serif;
    width: 100%;
    padding: 12px;
    font-size: 18px;
    border-radius: 4px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    border: 1px solid #E3E3E3;
    box-sizing: border-box;
  }
  input:focus {
    outline: none;
  }
  .message {
  padding-right: 20px;
  padding-left: 20px;
  padding-top: 16px;
  padding-bottom: 16px;
  border-radius: 12px;
  display: flex;
  align-items: center; /* align items to center by default */
}

.profile-picture {
  width: 32px;
  height: 32px;
  margin-right: 16px;
  border-radius: 50%;
  align-self: center;

  align-self: flex-start;
  margin-top: 4px;
}
.spacing{
  height: 100px;
}

h1{
  padding: 20px;
}

.csv-upload-label {
  display: inline-block;
  padding-top: 12px;
  padding-bottom: 12px;
  padding-left: 40px;
  padding-right: 40px;
  font-size: 18px;
  border-radius: 4px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  border: 1px solid #E3E3E3;
  background-color: white;
  text-align: center;
  cursor: pointer;
}

.csv-upload-label:hover {
  box-shadow: 0 0px 0px rgba(0, 0, 0, 0.2);
}

.hidden {
  display: none;
}

.csv-upload-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}


.uploaded-text {
  color: #858585;
}

.file-name-pill {
  background-color: #e8e8e8;
  border-radius: 12px;
  padding: 4px 12px;
  border-radius: 24px;
  font-family: 'Satoshi-Medium', sans-serif;
}

.container {
  display: flex;
  flex-wrap: wrap;
}

.chat-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  z-index: 1;
}

.chat-container {
  width: 600px;
  flex-grow: 1;
  max-height: calc(100vh - 16px - 16px - 1px); /* 16px for padding, 16px for #client-form padding, 1px for border-top */
  padding: 16px;
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  background-color: white;
  overflow-y: auto; 
  border-left: 1px solid #E3E3E3;
  box-shadow: 0px -1px 4px rgba(0, 0, 0, 0.15);
}

.csv-container {
  position: fixed;
  left: 0;
  right: 632px; /* adjust as needed */
  top: 0;
  bottom: 0;
  padding: 0px;
  box-sizing: border-box;
  overflow-x: auto;
}

.csv-container table {
  font-size: 13px;
  line-height: 17px;
  border-collapse: collapse;
  border: 1px solid #E3E3E3;
}

.csv-container th, .csv-container td {
    padding: 6px;
    border: 1px solid #E3E3E3;
    white-space:nowrap;
}
.highlighted-row {
  background-color: #DDF5EA;
}

.error {
  background-color: #FFE3DD;
}

.non-highlighted-row {
  background-color: none;
}


</style>
<body>
  <div class="csv-upload-wrapper">
    <label for="csv-upload" class="csv-upload-label">Upload CSV</label>
  </div>
  <input type="file" id="csv-upload" name="csv-upload" accept=".csv" style="display:none;">

  <div class = "container hidden">
    <div class = "chat-wrapper">
      <div class="chat-container hidden">
        <h1 class="hidden">Chat</h1>
        <form id="client-form" class="hidden">
          <input type="text" id="prompt" name="prompt" placeholder="Ask a question" autocomplete="off"  required>
        
        </form>

        <div id="messages" class="hidden"></div>
        <div class="spacing hidden"></div>
      </div>
    </div>
    <div class="csv-container hidden">
      <!-- CSV data code goes here -->
    </div>
  </div>
  
  

  <script>

const BASE_URL = (location.hostname === "localhost" || location.hostname === "127.0.0.1") ? "http://localhost:8080" : "https://aqueous-hamlet-06344.herokuapp.com";
    console.log("location.hostname:", location.hostname);
    console.log("BASE_URL:", BASE_URL);


    //code for csv upload
    const csvUpload = document.querySelector('#csv-upload');
    const csvUploadLabel = document.querySelector('.csv-upload-label');
    const hiddenElements = document.querySelectorAll('.hidden');

    csvUpload.addEventListener('change', async (event) => {
      if (event.target.files && event.target.files.length > 0) {
        // Hide the CSV upload button
        csvUploadLabel.style.display = 'none';

        // Show the rest of the UI
        hiddenElements.forEach((element) => {
          element.classList.remove('hidden');
        });

        // Display the uploaded file name
        const file = event.target.files[0];
        const fileName = file.name;
        displayUploadedFile(fileName);

        // Send the file to the server
        const formData = new FormData();
        formData.append('csv', file);
        try {
          const response = await fetch(`${BASE_URL}/upload_csv`, {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
        } catch (error) {
          console.error(error);
        }
      }
    });

    
    function displayUploadedFile(fileName) {
      const messagesDiv = document.querySelector('#messages');
      const uploadedFileMessage = `
        <div class="message">
          <img src="dad.jpg" class="profile-picture">
          <div><span class="uploaded-text">You uploaded</span> <span class="file-name-pill">${fileName}</span></div>
        </div>
        <div class="message">
          <img src="open.png" class="profile-picture">
          <div>Hi there. Ask me questions about your CSV.</div>
        </div>
      `;
      messagesDiv.innerHTML = uploadedFileMessage;

      const csvContainer = document.querySelector('.csv-container');
      const uploadedCSV = `
        <table id="csv-table"></table>
      `;
      csvContainer.innerHTML = uploadedCSV;

      // Read the contents of the CSV file and display in a table
      const fileInput = document.querySelector('#csv-upload');
      const reader = new FileReader();
      reader.readAsText(fileInput.files[0]);
      reader.onload = function (event) {
        const csv = event.target.result;
        const table = document.querySelector('#csv-table');
        let rows = csv.split('\n');
        // Remove last row if it's empty
        if (rows[rows.length - 1].trim() === '') {
          rows.pop();
        }
        // Parse CSV data
        for (let i = 0; i < rows.length; i++) {
          const cells = parseCSVRow(rows[i]);
          const row = document.createElement('tr');

          // Add a new cell at the beginning of each row containing the row number
          const rowIndexCell = document.createElement('td');
          rowIndexCell.textContent = i + 1;
          row.appendChild(rowIndexCell);

          for (let j = 0; j < cells.length; j++) {
            const cell = document.createElement('td');
            cell.textContent = cells[j];
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        //let table = document.querySelector('.csv-container');
        let columns = table.querySelectorAll('th, td');

        columns.forEach(column => {
          if (column.offsetWidth > 1200) {
            column.style.maxWidth = '1200px';
            column.style.whiteSpace = 'normal';
          }
        });
      };
    }

    // Helper function to parse a row of CSV data
    function parseCSVRow(row) {
      let cells = [];
      let currentCell = '';
      let withinQuotes = false;
      for (let i = 0; i < row.length; i++) {
        const char = row.charAt(i);
        if (char === ',' && !withinQuotes) {
          cells.push(currentCell.trim());
          currentCell = '';
        } else if (char === '"') {
          withinQuotes = !withinQuotes;
        } else {
          currentCell += char;
        }
      }
      cells.push(currentCell.trim());
      return cells;
    }








    const form = document.querySelector('#client-form');
    const messagesDiv = document.querySelector('#messages');

    function addMessageToDiv(prompt, messagesDiv, image) {
      const message = document.createElement('div');
      message.classList.add('message');
      message.classList.add('non-highlighted-row');
      const profilePicture = document.createElement('img');
      profilePicture.src = image; // set profile picture URL
      profilePicture.classList.add('profile-picture'); // add class to profile picture element

      const text = document.createElement('div');
      text.innerHTML = prompt;

      if (prompt === "Loading...") {
        text.classList.add('flash');
      }

      message.appendChild(profilePicture); // add profile picture element first
      message.appendChild(text);

      if (prompt !== "Loading..." && prompt !== "Loading for a bit longer..." && image === "open.png") {
        // Replace the last child element (the "Loading..." div) with the new message
        messagesDiv.lastElementChild.remove();
        messagesDiv.appendChild(message);

        if (
          !prompt.includes("I'm sorry, but I cannot understand your question.") &&
          !prompt.includes("There was an error.")
        ) {
          message.classList.remove('non-highlighted-row');
          message.classList.add('highlighted-row');
        } else if (prompt.includes("There was an error.")) {
          message.classList.add('error');
        }
      } else {
        messagesDiv.appendChild(message);
      }
    }

    window.addEventListener('beforeunload', async (event) => {
        // Cancel the event
        event.preventDefault();

        // Make an asynchronous request to the server to clear the data
        await fetch(`${BASE_URL}/clear_data`, {
            method: 'GET'
        });
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent the default form submission behavior
      let loadingTimeout;
      removeTableHighlights();
      removeChatHighlights();

      const promptInput = document.querySelector('#prompt');
      const prompt = promptInput.value;

      addMessageToDiv(prompt, messagesDiv, 'dad.jpg');
      addMessageToDiv("Loading...", messagesDiv, 'open.png');
      loadingTimeout = setTimeout(() => {
        if (messagesDiv.lastElementChild.querySelector('div').textContent === 'Loading...') {
          messagesDiv.lastElementChild.querySelector('div').textContent = 'Loading for a bit longer...';
        }
      }, 9000);
      promptInput.value = '';

      const data = { prompt };

      try {
        const response = await fetch(`${BASE_URL}/api`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        clearTimeout(loadingTimeout); // Clear the timeout
        if (response.ok) {
          const result = await response.json();
          console.log(result);
          const codeOutputResponse = await fetch(`${BASE_URL}/code_output`);
          const cResponse = await codeOutputResponse.json();
          console.log("ALL CODE OUTPUTS: ", cResponse);
          const textResponse = cResponse[cResponse.length-1].output;
          if (textResponse.includes("ANSWER:") && textResponse.includes("ROW INDICES:")) {
            const formattedTextResponseArray = extractAnswerAndRows(textResponse);
            const formattedTextResponse = formatTextResponseArray(formattedTextResponseArray);
            addMessageToDiv(formattedTextResponse[0], messagesDiv, 'open.png');
            const resultArray = JSON.parse(formattedTextResponse[1]);
            highlightRelevantRows(resultArray);
          } 
          else{
            addMessageToDiv("I'm sorry, but I cannot understand your question. Please provide a clear question related to the CSV data, and I will answer it.", messagesDiv, 'open.png');
          }
        }
        else{
          clearTimeout(loadingTimeout); // Clear the timeout
          addMessageToDiv("There was an error. You can try asking your question again or refreshing the page.", messagesDiv, 'open.png');
        }
        
      } catch (error) {
        clearTimeout(loadingTimeout); // Clear the timeout
        console.error(error);
        addMessageToDiv("There was an error. You can try asking your question again or refreshing the page.", messagesDiv, 'open.png');
      }
    });

    function formatTextResponseArray(inputArray) {
      let answers = [];
      let rowIndices = [];

      inputArray.forEach(pair => {
        answers.push(pair[0]);
        let rowIndexArray = JSON.parse(pair[1]);
        rowIndices.push(...rowIndexArray);
      });

      let combinedAnswers = answers.join(', ');
      let combinedRowIndices = JSON.stringify(rowIndices);

      return [combinedAnswers, combinedRowIndices];
    }

    function extractAnswerAndRows(inputString) {
      const regex = /ANSWER:\s*(.+?),\s*ROW INDICES:\s*(.+?)(?=\nANSWER:|$)/g;
      const results = [];
      let match;

      while ((match = regex.exec(inputString)) !== null) {
        if (match.length > 2) {
          const answer = match[1].trim();
          const rows = match[2].trim();
          results.push([answer, rows]);
        }
      }
      return results.length > 0 ? results : null;
    }

    function highlightRelevantRows(rowIndices) {
      const table = document.querySelector('#csv-table');
      const rows = table.querySelectorAll('tr');

      rows.forEach((row, index) => {
        if (rowIndices.includes(index)) {
          row.classList.add('highlighted-row');
          row.classList.remove('non-highlighted-row');
        } else {
          row.classList.add('non-highlighted-row');
          row.classList.remove('highlighted-row');
        }
      });
    }

    function removeTableHighlights(){
      const table = document.querySelector('#csv-table');
      const rows = table.querySelectorAll('tr');

      rows.forEach((row) => {
        row.classList.add('non-highlighted-row');
        row.classList.remove('highlighted-row');
      });
    }

    function removeChatHighlights(){
      const messages = document.querySelector('#messages');
      const divs = messages.querySelectorAll('div');
      divs.forEach((div) => {
        div.classList.add('non-highlighted-row');
        div.classList.remove('highlighted-row');
      });
    }



  </script>
</body>
</html>