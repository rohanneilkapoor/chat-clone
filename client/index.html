<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
</head>
<style>
  @font-face {
    font-family: 'Satoshi-Regular';
    src: url('../fonts/Satoshi-Regular.woff2') format('woff2'),
        url('../fonts/Satoshi-Regular.woff') format('woff'),
        url('../fonts/Satoshi-Regular.ttf') format('truetype');
        font-weight: 400;
        font-display: swap;
        font-style: normal;
  }
  @font-face {
    font-family: 'Satoshi-Medium';
    src: url('../fonts/Satoshi-Medium.woff2') format('woff2'),
        url('../fonts/Satoshi-Medium.woff') format('woff'),
        url('../fonts/Satoshi-Medium.ttf') format('truetype');
        font-weight: 400;
        font-display: swap;
        font-style: normal;
  }
  body {
      font-family: 'Satoshi-Regular', sans-serif;
      margin: 0 auto;
      font-size: 18px;
      line-height: 28px;
      background-color: #FAFAFA;
      -webkit-user-select: text; /* for Chrome and Safari */
      -moz-user-select: text; /* for Firefox */
      -ms-user-select: text; /* for Internet Explorer and Edge */
      user-select: text; /* standard syntax */
  }

  td {
    vertical-align: top;
  }

  #client-form {
    position: fixed;
    bottom: 0;
    padding-bottom: 32px;
    width: 100%;
    max-width: 600px; /* adjust as needed */
    box-sizing: border-box;
  }
  input {
    font-family: 'Satoshi-Regular', sans-serif;
    width: 100%;
    padding: 12px;
    font-size: 18px;
    border-radius: 4px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    border: 1px solid #E3E3E3;
    box-sizing: border-box;
  }
  input:focus {
    outline: none;
  }
  .message {
  padding-bottom: 40px;
  display: flex;
  align-items: center; /* align items to center by default */
}

.profile-picture {
  width: 32px;
  height: 32px;
  margin-right: 16px;
  border-radius: 50%;
  align-self: center;

  align-self: flex-start;
  margin-top: 4px;
}
.spacing{
  height: 100px;
}

h1{
  padding-bottom: 28px;
}

.csv-upload-label {
  display: inline-block;
  padding-top: 12px;
  padding-bottom: 12px;
  padding-left: 40px;
  padding-right: 40px;
  font-size: 18px;
  border-radius: 4px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  border: 1px solid #E3E3E3;
  background-color: white;
  text-align: center;
  cursor: pointer;
}

.csv-upload-label:hover {
  box-shadow: 0 0px 0px rgba(0, 0, 0, 0.2);
}

.hidden {
  display: none;
}

.csv-upload-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}


.uploaded-text {
  color: #858585;
}

.file-name-pill {
  background-color: #e8e8e8;
  border-radius: 12px;
  padding: 4px 12px;
  border-radius: 24px;
  font-family: 'Satoshi-Medium', sans-serif;
}

.container {
  display: flex;
  flex-wrap: wrap;
}

.chat-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  z-index: 1;
}

.chat-container {
  width: 600px;
  flex-grow: 1;
  max-height: calc(100vh - 32px - 16px - 1px); /* 32px for padding, 16px for #client-form padding, 1px for border-top */
  padding: 32px;
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  background-color: white;
  overflow-y: auto; 
  border-left: 1px solid #E3E3E3;
  box-shadow: 0px -1px 4px rgba(0, 0, 0, 0.15);
}

.csv-container {
  position: fixed;
  left: 0;
  right: 664px; /* adjust as needed */
  top: 0;
  bottom: 0;
  padding: 0px;
  box-sizing: border-box;
  overflow-x: auto;
}

.csv-container table {
  font-size: 13px;
  line-height: 17px;
  border-collapse: collapse;
  border: 1px solid #E3E3E3;
}

.csv-container th, .csv-container td {
    padding: 6px;
    border: 1px solid #E3E3E3;
    white-space:nowrap;
}
.highlighted-row {
  background-color: #fff2e5;
}


</style>
<body>
  <div class="csv-upload-wrapper">
    <label for="csv-upload" class="csv-upload-label">Upload CSV</label>
  </div>
  <input type="file" id="csv-upload" name="csv-upload" accept=".csv" style="display:none;">

  <div class = "container hidden">
    <div class = "chat-wrapper">
      <div class="chat-container hidden">
        <h1 class="hidden">Chat</h1>
        <form id="client-form" class="hidden">
          <input type="text" id="prompt" name="prompt" placeholder="Ask a question" autocomplete="off"  required>
        
        </form>

        <div id="messages" class="hidden"></div>
        <div class="spacing hidden"></div>
      </div>
    </div>
    <div class="csv-container hidden">
      <!-- CSV data code goes here -->
    </div>
  </div>
  
  

  <script>




    //code for csv upload
    const csvUpload = document.querySelector('#csv-upload');
    const csvUploadLabel = document.querySelector('.csv-upload-label');
    const hiddenElements = document.querySelectorAll('.hidden');

    csvUpload.addEventListener('change', async (event) => {
      if (event.target.files && event.target.files.length > 0) {
        // Hide the CSV upload button
        csvUploadLabel.style.display = 'none';

        // Show the rest of the UI
        hiddenElements.forEach((element) => {
          element.classList.remove('hidden');
        });

        // Display the uploaded file name
        const file = event.target.files[0];
        const fileName = file.name;
        displayUploadedFile(fileName);

        // Send the file to the server
        const formData = new FormData();
        formData.append('csv', file);
        try {
          const response = await fetch('http://localhost:8080/upload_csv', {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
        } catch (error) {
          console.error(error);
        }
      }
    });

    
    function displayUploadedFile(fileName) {
      const messagesDiv = document.querySelector('#messages');
      const uploadedFileMessage = `
        <div class="message">
          <img src="dad.jpg" class="profile-picture">
          <div><span class="uploaded-text">You uploaded</span> <span class="file-name-pill">${fileName}</span></div>
        </div>
        <div class="message">
          <img src="open.png" class="profile-picture">
          <div>Hi there. Ask me questions about <span class="file-name-pill">${fileName}</span></div>
        </div>
      `;
      messagesDiv.innerHTML = uploadedFileMessage;

      const csvContainer = document.querySelector('.csv-container');
      const uploadedCSV = `
        <table id="csv-table"></table>
      `;
      csvContainer.innerHTML = uploadedCSV;

      // Read the contents of the CSV file and display in a table
      const fileInput = document.querySelector('#csv-upload');
      const reader = new FileReader();
      reader.readAsText(fileInput.files[0]);
      reader.onload = function (event) {
        const csv = event.target.result;
        const table = document.querySelector('#csv-table');
        let rows = csv.split('\n');
        // Remove last row if it's empty
        if (rows[rows.length - 1].trim() === '') {
          rows.pop();
        }
        // Parse CSV data
        for (let i = 0; i < rows.length; i++) {
          const cells = parseCSVRow(rows[i]);
          const row = document.createElement('tr');
          for (let j = 0; j < cells.length; j++) {
            const cell = document.createElement('td');
            cell.textContent = cells[j];
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        //let table = document.querySelector('.csv-container');
        let columns = table.querySelectorAll('th, td');

        columns.forEach(column => {
          if (column.offsetWidth > 1200) {
            column.style.maxWidth = '1200px';
            column.style.whiteSpace = 'normal';
          }
        });
      };
    }

    // Helper function to parse a row of CSV data
    function parseCSVRow(row) {
      let cells = [];
      let currentCell = '';
      let withinQuotes = false;
      for (let i = 0; i < row.length; i++) {
        const char = row.charAt(i);
        if (char === ',' && !withinQuotes) {
          cells.push(currentCell.trim());
          currentCell = '';
        } else if (char === '"') {
          withinQuotes = !withinQuotes;
        } else {
          currentCell += char;
        }
      }
      cells.push(currentCell.trim());
      return cells;
    }







    const form = document.querySelector('#client-form');
    const messagesDiv = document.querySelector('#messages');

    function addMessageToDiv(prompt, messagesDiv, image) {
      const message = document.createElement('div');
      message.classList.add('message');
      const profilePicture = document.createElement('img');
      profilePicture.src = image; // set profile picture URL
      profilePicture.classList.add('profile-picture'); // add class to profile picture element

      const text = document.createElement('div');
      text.innerHTML = prompt;
      
      if(prompt != "Loading..." && image == "open.png"){
        //replace last child element with prompt
        const lastChildText = messagesDiv.lastElementChild.lastElementChild;
        lastChildText.textContent = prompt;

      } else{
        message.appendChild(profilePicture); // add profile picture element first
        message.appendChild(text);
        
        messagesDiv.appendChild(message);
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent the default form submission behavior

      const promptInput = document.querySelector('#prompt');
      const prompt = promptInput.value;

      addMessageToDiv(prompt, messagesDiv, 'dad.jpg');
      addMessageToDiv("Loading...", messagesDiv, 'open.png');
      promptInput.value = ''; 

      const data = { prompt };

      try {
        const response = await fetch('http://localhost:8080/api', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        console.log(result);
        const codeOutputResponse = await fetch('http://localhost:8080/code_output');
        const cResponse = await codeOutputResponse.json();
        console.log(cResponse[0].output);
        const textResponse = cResponse[cResponse.length-1].output;
        const formattedTextResponse = extractAnswerAndRows(textResponse);
        addMessageToDiv(formattedTextResponse[0], messagesDiv, 'open.png');
        const resultArray = JSON.parse(formattedTextResponse[1]);
        highlightRelevantRows(resultArray);
      } catch (error) {
        console.error(error);
      }
    });

    function extractAnswerAndRows(inputString) {
      const regex = /ANSWER:\s*(.+),\s*ROW INDICES:\s*(.+)/;
      const match = regex.exec(inputString);
      if (match && match.length > 2) {
        const answer = match[1].trim();
        const rows = match[2].trim();
        return [answer, rows];
      }
      return null;
    }

    function highlightRelevantRows(rowIndices) {
      const table = document.querySelector('#csv-table');
      const rows = table.querySelectorAll('tr');

      rowIndices.forEach(index => {
        if (index < rows.length) {
          rows[index].classList.add('highlighted-row');
        }
      });
    }



  </script>
</body>
</html>